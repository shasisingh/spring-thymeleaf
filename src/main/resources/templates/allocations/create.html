<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content})}" th:inline="javascript"
      lang="en">
<section th:fragment="content">
    <div class="card">
        <h2>Allocate Room</h2>
        <form th:object="${allocation}" th:action="@{/api/v1/allocations/create}" method="post" class="form-vertical"
              id="allocationForm">
            <div class="section-divider">Stay</div>
            <!-- Stack hostel and room vertically -->
            <label>
                <span>Hostel <span aria-hidden="true" title="Required">*</span></span>
                <select th:field="*{hostelId}" id="hostelSelect" name="hostelId" required>
                    <option value="" disabled
                            th:selected="${allocation.hostelId == null}">Select hostel
                    </option>
                    <option th:each="hostel : ${hostels}" th:value="${hostel.id}" th:text="${hostel.name}"
                            th:selected="${hostel.id} == ${allocation.hostelId}"></option>
                </select>
            </label>
            <label style="position:relative">
                <span>Room <span aria-hidden="true" title="Required">*</span> <span id="roomSpinner"
                                                                                    class="inline-spinner"
                                                                                    style="display:none"></span></span>
                <select th:field="*{hostelRoomNumber}" id="roomSelect" name="hostelRoomNumber" required disabled>
                    <option value="" disabled selected>Select room</option>
                </select>
                <!-- overlay spinner inside field -->
                <span id="roomSelectOverlay" class="inline-spinner"
                      style="display:none; position:absolute; right:.6rem; top:2.4rem"></span>
                <input type="hidden" id="roomIdInput" name="roomId" th:value="${selectedRoomId}"/>
            </label>

            <!-- Stack check-in and check-out vertically -->
            <label>
                <span>Check-in <span aria-hidden="true" title="Required">*</span></span>
                <input type="datetime-local" th:field="*{checkIn}" required
                       th:value="${#temporals.format(T(java.time.LocalDateTime).now(), 'yyyy-MM-dd''T''HH:mm')}"/>
                <div class="field-error" th:if="${#fields.hasErrors('checkIn')}" th:errors="*{checkIn}"></div>
            </label>
            <label>
                <span>Check-out <span aria-hidden="true" title="Required">*</span></span>
                <input type="datetime-local" th:field="*{checkOut}" required
                       th:value="${#temporals.format(T(java.time.LocalDateTime).now().plusDays(2), 'yyyy-MM-dd''T''HH:mm')}"/>
                <div class="field-error" th:if="${#fields.hasErrors('checkOut')}" th:errors="*{checkOut}"></div>
            </label>

            <div class="section-divider">Guest</div>
            <!-- Guest fields stacked vertically -->
            <label>
                <span>Full name <span aria-hidden="true" title="Required">*</span></span>
                <input type="text" th:field="*{fullName}" placeholder="Enter full name" required>
                <div class="field-error" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></div>
            </label>
            <label>
                <span>Email <span aria-hidden="true" title="Required">*</span></span>
                <input type="email" th:field="*{email}" placeholder="Enter email" required>
                <div class="field-error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
                <div class="field-hint">We'll use your email for booking updates only.</div>
            </label>
            <label>
                <span>Address <span aria-hidden="true" title="Required">*</span></span>
                <input type="text" th:field="*{address}" placeholder="Enter address" required>
                <div class="field-error" th:if="${#fields.hasErrors('address')}" th:errors="*{address}"></div>
            </label>
            <label>
                <span>Date of birth <span aria-hidden="true" title="Required">*</span></span>
                <input type="date" th:field="*{dob}" required
                       th:value="${#temporals.format(allocation.dob, 'yyyy-MM-dd')}">
                <div class="field-error" th:if="${#fields.hasErrors('dob')}" th:errors="*{dob}"></div>
            </label>

            <div class="section-divider">Payment & Identity</div>
            <!-- Stack identity and payment vertically -->
            <label>
                <span>Identity document <span aria-hidden="true" title="Required">*</span></span>
                <select th:field="*{identityDoc}" required>
                    <option value="" disabled selected>Select identity document</option>
                    <option th:each="idoc : ${identityDocs}" th:value="${idoc}" th:text="${idoc}"></option>
                </select>
                <div class="field-error" th:if="${#fields.hasErrors('identityDoc')}"
                     th:errors="*{identityDoc}"></div>
                <div class="field-hint">Bring this document at check-in.</div>
            </label>
            <label>
                <span>Payment method <span aria-hidden="true" title="Required">*</span></span>
                <select th:field="*{paymentMethod}" required>
                    <option value="" disabled selected>Select payment method</option>
                    <option th:each="pm : ${paymentMethods}" th:value="${pm}" th:text="${pm}"></option>
                </select>
                <div class="field-error" th:if="${#fields.hasErrors('paymentMethod')}"
                     th:errors="*{paymentMethod}"></div>
            </label>

            <div class="actions" style="margin-top:.75rem">
                <button class="btn" type="submit" id="saveBtn">Save Allocation</button>
                <a class="btn" th:href="@{/api/v1/allocations}" style="background:#6c757d">Cancel</a>
                <button class="btn secondary" type="button" id="previewBtn">Preview</button>
            </div>
        </form>

        <div class="card" id="previewCard" style="display:none;" role="dialog" aria-modal="true"
             aria-labelledby="previewTitle">
            <h3 id="previewTitle">Summary</h3>
            <p><strong>Guest:</strong> <span id="prevName"></span> — <span id="prevEmail"></span></p>
            <p><strong>Address:</strong> <span id="prevAddress"></span></p>
            <p><strong>Identity:</strong> <span id="prevIdDoc"></span> | <strong>Payment:</strong> <span
                    id="prevPay"></span></p>
            <p><strong>Hostel:</strong> <span id="prevHostel"></span> | <strong>Room:</strong> <span
                    id="prevRoom"></span></p>
            <p><strong>Stay:</strong> <span id="prevCheckIn"></span> → <span id="prevCheckOut"></span></p>
            <div class="actions">
                <button class="btn" type="button" id="closePreview">Close</button>
            </div>
        </div>
    </div>

    <script>
        window.__selectedHostelId = /*[[${selectedHostelId}]]*/ null;
    </script>
    <script th:if="${includeAllocationsCreateScript} ?: true" defer th:src="@{/js/allocations-create.js}"></script>
</section>
</html>
